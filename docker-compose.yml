# RedisLens Development Docker Compose
# Provides various Redis configurations for testing.
#
# Usage:
#   make docker-redis        Start standalone Redis
#   make docker-cluster      Start Redis Cluster (6 nodes)
#   make docker-sentinel     Start Redis Sentinel setup
#   make docker-all          Start everything
#   make docker-down         Stop everything

services:
  # ─── Standalone Redis (default) ───────────────────────────────

  redis-standalone:
    image: redis:7-alpine
    container_name: redis-standalone
    ports:
      - "6379:6379"
    command: >
      redis-server
        --save ""
        --appendonly no
        --maxmemory 256mb
        --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  # ─── Redis with AUTH ──────────────────────────────────────────

  redis-auth:
    image: redis:7-alpine
    container_name: redis-auth
    ports:
      - "6380:6379"
    command: >
      redis-server
        --requirepass redislens
        --save ""
        --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redislens", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  # ─── Redis with ACL (username + password) ─────────────────────

  redis-acl:
    image: redis:7-alpine
    container_name: redis-acl
    ports:
      - "6382:6379"
    command: >
      redis-server
        --save ""
        --appendonly no
        --user default off
        --user admin on ">adminpass" "~*" "&*" "+@all"
        --user readonly on ">readpass" "~*" "&*" "+@read" "+@connection"
    healthcheck:
      test: ["CMD", "redis-cli", "--user", "admin", "--pass", "adminpass", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  # ─── Redis with TLS ──────────────────────────────────────────

  redis-tls:
    image: redis:7-alpine
    container_name: redis-tls
    ports:
      - "6381:6381"
    volumes:
      - ./docker/tls:/tls:ro
    command: >
      redis-server
        --port 0
        --tls-port 6381
        --tls-cert-file /tls/redis.crt
        --tls-key-file /tls/redis.key
        --tls-ca-cert-file /tls/ca.crt
        --tls-auth-clients no
        --save ""
        --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "--tls", "--cacert", "/tls/ca.crt", "-p", "6381", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  # ─── Redis Cluster (6 nodes: 3 masters + 3 replicas) ─────────

  redis-cluster-1:
    image: redis:7-alpine
    container_name: redis-cluster-1
    ports:
      - "7000:7000"
    command: >
      redis-server
        --port 7000
        --cluster-enabled yes
        --cluster-config-file nodes.conf
        --cluster-node-timeout 5000
        --appendonly no
        --save ""
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7000", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  redis-cluster-2:
    image: redis:7-alpine
    container_name: redis-cluster-2
    ports:
      - "7001:7001"
    command: >
      redis-server
        --port 7001
        --cluster-enabled yes
        --cluster-config-file nodes.conf
        --cluster-node-timeout 5000
        --appendonly no
        --save ""

  redis-cluster-3:
    image: redis:7-alpine
    container_name: redis-cluster-3
    ports:
      - "7002:7002"
    command: >
      redis-server
        --port 7002
        --cluster-enabled yes
        --cluster-config-file nodes.conf
        --cluster-node-timeout 5000
        --appendonly no
        --save ""

  redis-cluster-4:
    image: redis:7-alpine
    container_name: redis-cluster-4
    ports:
      - "7003:7003"
    command: >
      redis-server
        --port 7003
        --cluster-enabled yes
        --cluster-config-file nodes.conf
        --cluster-node-timeout 5000
        --appendonly no
        --save ""

  redis-cluster-5:
    image: redis:7-alpine
    container_name: redis-cluster-5
    ports:
      - "7004:7004"
    command: >
      redis-server
        --port 7004
        --cluster-enabled yes
        --cluster-config-file nodes.conf
        --cluster-node-timeout 5000
        --appendonly no
        --save ""

  redis-cluster-6:
    image: redis:7-alpine
    container_name: redis-cluster-6
    ports:
      - "7005:7005"
    command: >
      redis-server
        --port 7005
        --cluster-enabled yes
        --cluster-config-file nodes.conf
        --cluster-node-timeout 5000
        --appendonly no
        --save ""

  # ─── Redis Sentinel Setup ────────────────────────────────────

  redis-master:
    image: redis:7-alpine
    container_name: redis-master
    ports:
      - "6400:6379"
    command: >
      redis-server
        --save ""
        --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  redis-replica-1:
    image: redis:7-alpine
    container_name: redis-replica-1
    ports:
      - "6401:6379"
    command: >
      redis-server
        --replicaof redis-master 6379
        --save ""
        --appendonly no
    depends_on:
      redis-master:
        condition: service_healthy

  redis-replica-2:
    image: redis:7-alpine
    container_name: redis-replica-2
    ports:
      - "6402:6379"
    command: >
      redis-server
        --replicaof redis-master 6379
        --save ""
        --appendonly no
    depends_on:
      redis-master:
        condition: service_healthy

  redis-sentinel-1:
    image: redis:7-alpine
    container_name: redis-sentinel-1
    ports:
      - "26379:26379"
    command: >
      sh -c "
        echo 'sentinel monitor mymaster redis-master 6379 2' > /tmp/sentinel.conf &&
        echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
        echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
        echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      "
    depends_on:
      redis-master:
        condition: service_healthy

  redis-sentinel-2:
    image: redis:7-alpine
    container_name: redis-sentinel-2
    ports:
      - "26380:26379"
    command: >
      sh -c "
        echo 'sentinel monitor mymaster redis-master 6379 2' > /tmp/sentinel.conf &&
        echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
        echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
        echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      "
    depends_on:
      redis-master:
        condition: service_healthy

  redis-sentinel-3:
    image: redis:7-alpine
    container_name: redis-sentinel-3
    ports:
      - "26381:26379"
    command: >
      sh -c "
        echo 'sentinel monitor mymaster redis-master 6379 2' > /tmp/sentinel.conf &&
        echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
        echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
        echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      "
    depends_on:
      redis-master:
        condition: service_healthy
